\documentclass{article}
    % General document formatting
    \usepackage[margin=0.7in]{geometry}
    \usepackage[parfill]{parskip}
    \usepackage[utf8]{inputenc}

    % Images
    \usepackage{graphicx}

    % Colors
    \usepackage{xcolor}
    
    % Related to math
    \usepackage{amsmath,amssymb,amsfonts,amsthm,bm}

\begin{document}

\subsection*{Dynamic Simulation}
\subsubsection*{TODOS}
\begin{itemize}
    \item What is dynamic simulation?
    \item What is the standard approach?
    \item What are the challenges?
    \item Enter constraints!
\end{itemize}

Simulating effects such as incompressibility, inextensibility and joints between atriculated rigid bodies 
can be achieved in elasticity-based simulations by using high stiffness values. High stiffness values lead to 
large forces which in turn cause numerical issues in the solver. 

We demonstrate these issues based on the example of maintaining a desired distance between two points using a stiff 
spring \cite{tournier2015}. Let $\bm{x_1, x_2}$ be the positions, $\bm{v_1, v_2}$ the velocities and $\bm{a_1, a_2}$
be the accelerations of the two particles. Let $\overline{l}$ be the rest length and $l = \lVert \bm{x_1} - \bm{x_2} \rVert$ 
be the current length of the spring with stiffness $k$. It can be shown that the force that the spring applies at each particle
is equal to $\bm{f_1} = -\bm{f_2} = \lambda\bm{u}$, where $\bm{u} = (\bm{x_1} - \bm{x_2}) / l$
and $\lambda = -\frac{\delta V}{\delta l} = k(\overline{l} - l)$. 

Once the forces, accelerations, velocities and positions are combined into a single vectors $\bm{f}, \bm{a}, \bm{v}, \bm{x}$, 
respectively, the motions of the system can be modeled via Newton's Ordinary Differential Equation (ODE) $\bm{f} = \bm{Ma}$,
where $\bm{M}$ is a $n_d \times n_d$ diagonal matrix and $n_d$ is the total number of independent degrees of freedom for the 
particles.

This system can be integrated via the symplectic Euler method as follows:

\begin{align*}
    \bm{v_{n+1}} &= \bm{v_n} + h\bm{a_n} \\
    \bm{x_{n+1}} &= \bm{x_n} + h\bm{v_{n+1}}
\end{align*}

As the stiffness $k$ of the spring increases, so does the magnitude of the acceleration $\bm{a}$. Consequently, the integration
diverges unless the timestep is prohibitively small. The stability issues are often addressed by switching to an implicit 
integration scheme, such as the backward Euler method \cite{baraff1998}. Replacing current accelerations with future accelerations
requires the solution of the following linear system of equations (LSE):

\[
    (\bm{M} - h^2\bm{K})\bm{\Delta v} = \bm{p} + h\bm{f}
\]

where $\bm{\Delta v} = \bm{v_{n+1}} - \bm{v_{n}}$, $\bm{p} = \bm{Mv}$ is the momentum, and $\bm{K} = \frac{\delta \bm{f}}{\delta \bm{x}}$ 
is the stiffness matrix. \textcolor{red}{Check whether using $\Delta v$ is correct here. Check \cite{baraff1998}}. \textcolor{blue}{This
this system is in terms of $\Delta v$ only (no $\Delta x$), because $\Delta x$ can be expressed in terms of $\Delta v$, allowing $\Delta x$ 
to be moved out of the equation.} Note that $\bm{K}$ is typically non-singular since elastic forces are invariant under rigid body 
transforms. When using large stiffness $k$ for springs, the entries of $\bm{K}$ are large (due to large restorative forces for stiff 
springs) and dominate the entries of the system matrix $\bm{H} = \bm{M} - h^2\bm{K}$. In these cases, $\bm{H}$ will be almost non-singular 
as well, leading to numerical issues and poor convergence for many solvers.

\subsection*{Constraint-based Dynamics}

\subsubsection*{Hard Constraints}
The problem of maintaining hard distance constraints between particles can be formulated as a Differential Algebraic Equation (DAE)
\cite{ascher1995, baraff1996}. In this framework, the standard ODE $\bm{f} = \bm{Ma}$ is handled together with algebraic equations 
that model the constraints on the system. Distance constraints are typically implemented using holonomic constraints of the form 
$\bm{psi(x)} = 0$. Note that the distance constraint $\bm{psi}(x)$ is formulated in terms of the particle positions, whereas the ODE
works on accelerations or velocities. Consequently, the constraints need to be differentiated once or twice so that they can be 
combined with the ODE in terms of velocties or accelerations, respectively. \textcolor{blue}{In xPBD, we go the other way! The ODE
is tanslated so that it is in terms of positions, so that it can be handled together with the constraints. Is there a reason nobody bothered to
do this before? What are the challenges here? Is this exactly what xPBD is? Is there a way to view the simplifications made in 
terms of the other frameworks?}. Using $\bm{J} = \frac{\delta \bm{psi}}{\delta \bm{x}}$, where $\bm{J}$ is a $n_c \times n_d$ matrix
and $n_c$ is the number of scalar constraints, this leads to the following constraint formulations:

\begin{align*}
    \bm{Jv} &= 0 \\
    \bm{Ja} &= \bm{c(v)}
\end{align*}

for some $\bm{c(v)}$. \textcolor{red}{If you check \cite{ascher1995}, see that $c(v)$ also depends on the positions $q$. That should be indicated!} 
Additionally, constraint forces are required in order to link the algebraic constraint equations with the ODE describing the motion of 
the system. It can be shown that the constraint forces $\bm{f_c}$ applied to the particles have to be in the following form in order to 
avoid adding linear and angular momentum to the system \cite{baraff1996}:

\[
    \bm{f_c} = \bm{J^T \lambda}
\]

where the $\lambda$ are the Lagrange multipliers of the constraints. The DAE can now be expressed in an impulse-based \cite{tournier2015}

\[
\begin{pmatrix}
    \bm{M} & \bm{-J^T} \\
    \bm{J} & 0
\end{pmatrix}
\begin{pmatrix}
    \bm{v} \\
    \bm{\mu}
\end{pmatrix}
=
\begin{pmatrix}
    \bm{p} + h\bm{f_e} \\
    0
\end{pmatrix}
\]

where $\bm{\mu} = h \bm{\lambda}$ and $\bm{f_e}$ are the external forces, or in a force-based formulation \cite{ascher1995}:

\[
\begin{pmatrix}
    \bm{M} & \bm{J^T} \\
    \bm{J} & 0
\end{pmatrix}
\begin{pmatrix}
    \bm{a} \\
    \bm{\lambda}
\end{pmatrix}
=
\begin{pmatrix}
    \bm{f_e} \\
    \bm{c(v)}
\end{pmatrix}
\]

Note that in either case the lower block-row of the system drives towards velocities or accelerations that satisfy the constraints 
imposed by $\bm{\psi(x)}$ (or striclty speaking the differentiations thereof) exactly. This is indicated by the lower-right zero
block in the system matrix in either formulation. \textcolor{blue}{Aren't $\dot{q} = v$ and $\dot{v} = a$ also part of the 
differential equation? Because $c(v)$ and $f_e$ also depend on $q$!}

In both cases the system matrix is sparse. This can be exploited by sparse matrix solvers which work on it directly \cite{baraff1996}.
Alternatively, the Schur complement can be employed due to the non-singularity of the mass matrix in the upper-left block to arrive
at a smaller, albeit less sparse, system. For the impulse-based approach described in \cite{tournier2015}, this yields:

\[
    \bm{JM^{-1}J^T \mu} = \bm{-JM^{-1}(p + } h \bm{f_e)}
\]

If the constraints are not redundant, $\bm{JM^{-1}J^T}$ is non-singular and symmetric positive definite \cite{baraff1996}. In 
\cite{ascher1995} the $\lambda$ are eliminated from the system entirely, yielding an ODE in terms of positions and velocities. However,
when the tensile force with respect to particle masses is large, instabilities in the transverse direction of the constraints occur.

% Bibliography ------------------------------------------------------------------------

\bibliographystyle{plain}
\bibliography{bibliography/references}

\end{document}
